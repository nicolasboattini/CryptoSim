//Declaramos las variables básicas
var graficaData;
var criptoValue;

var datosx = [44063.28198279571,
40562.98694982819,
40073.495362369824,
40192.75912143141,
38514.00853622455,
37059.979402287514,
38337.2038554348,
37372.2926803477,
38363.345488570165,
39316.16207578596,
39090.202153609054,
37803.59016044929,
43225.404677435734,
44459.59162774341,
43980.707382090906,
42491.97839335905,
39200.29973557414,
39463.14681149058,
38442.99174588676,
38076.49382252028,
38732.93701302586,
41986.03444607623,
39468.35477300189,
38775.17558840679,
38903.69354800599,
37852.52514106289,
39669.423812004505,
39331.84654059453,
41165.63506140341,
41001.70957801974,
41837.41313797566,
42201.939920688186,
41283.25900104565,
41061.81589384987,
42401.895597489434,
42802.15471016985,
43936.09623454058,
44331.77795706412,
44510.84421762133,
46715.1176185105,
46994.879118357465,
47459.261237539096,
47063.36584996355,
45528.40715313835,
46270.20070585378,
45842.14476317382,
46434.562982661664,
46622.63571309101,
45635.45438126673,
43198.77526936491,
43515.15032279806,
42315.70972421807,
42796.39747810973,
42274.907370256085,
39603.965159284155,
40205.67794073206,
41205.16871904067,
39959.457069033735,
40586.59730938673,
40450.37930543977,
39739.11925622209,
40833.5379650337,
41498.12244669832,
41397.220477279625,
40528.54148675958,
39756.848993471016,
39561.78019075613,
39469.04986198146,
40488.877917622376,
38134.21545068938,
39237.94931747103,
39741.766645809636,
38650.55013809267,
37820.61176529208,
38537.65476669535,
38561.56539902362,
37758.496107734,
39699.02404125388,
36612.229548803036,
36116.394294982965,
35573.31019883488,
34070.31219757961,
30269.586956629482,
31026.93386836242,
28913.48836365432,
29126.11597686014,
29310.728959858257,
30189.333177005963,
31319.309111130002,
29923.606993639707,
30502.19328027689,
28772.200501112577,
30382.40624219559,
29256.813374416255,
29491.507947760598,
30351.050417138096,
29163.167775739188,
29655.02613175249,
29584.949851985926,
29346.781442431617,
28646.65218193245,
29088.236452817226,
29492.503214953642,
31740.94072516695,
31865.749621173167,
29833.450330205254,
30481.013996026013,
29714.143487149733,
29872.3603087139,
29917.764052456198,
31372.5847629755,
31265.469277693348,
30229.236836130378,
30101.187521431468,
29101.2982596468,
28374.14499732395,
26767.269173221313,
22525.768350391198,
22244.848968001315,
22529.198114649807];

var datos = [3128.640780542462,
  2881.613122162859,
  2792.3038477186237,
  2768.9716520348597,
  2632.49139911745,
  2574.513383778016,
  2644.153655546016,
  2594.700959110155,
  2599.9335696870216,
  2771.890509646429,
  2785.3389569017427,
  2629.48312082149,
  2919.294962425658,
  2977.276039756805,
  2953.315776286441,
  2836.9063366005576,
  2619.356137634489,
  2668.70597865687,
  2558.359874049847,
  2498.658864965217,
  2576.6271539947625,
  2731.037685293996,
  2611.4647225047097,
  2562.8323535359655,
  2579.4581356883637,
  2518.492845270615,
  2591.5420409591425,
  2620.363852420936,
  2771.759457292368,
  2817.401074966818,
  2945.7459101862714,
  2947.226158224087,
  2860.641960901919,
  2896.5869324317464,
  2969.78498365825,
  3028.8352577107285,
  3106.657023584939,
  3106.072054158695,
  3140.8757105064406,
  3285.1730967305425,
  3328.9341246867148,
  3401.184431040135,
  3383.7887617814154,
  3283.3028425717257,
  3451.1960908672754,
  3440.3362384891684,
  3521.5847247785246,
  3520.9671175043636,
  3422.9698837547116,
  3171.371104498954,
  3232.834988999582,
  3192.0250912893603,
  3265.938067729151,
  3219.159553453764,
  2992.7021064252435,
  3038.209421996366,
  3121.399823462041,
  3023.417211885316,
  3045.42807480128,
  3066.3580141449797,
  2995.719421019825,
  3061.8905711469047,
  3104.688447526111,
  3079.6764776018495,
  2987.4888760341605,
  2967.085285238213,
  2940.6879777714407,
  2922.901865199808,
  3008.3363470853,
  2806.748835957046,
  2889.5922230230817,
  2932.455083612903,
  2817.4898821916195,
  2738.1741359527714,
  2832.513106895354,
  2861.3723755560436,
  2786.0472478011084,
  2942.052313122658,
  2753.936566546688,
  2699.7072470893745,
  2641.229106940243,
  2517.8299224886478,
  2249.8909622207443,
  2344.797715643986,
  2080.910243657776,
  1966.6991711336661,
  2010.214051125259,
  2064.229357512243,
  2147.047447880575,
  2025.8886983912162,
  2095.178884796724,
  1915.1771232664505,
  2023.8482593608173,
  1963.9909395294865,
  1978.1471325624789,
  2046.6463496545232,
  1974.5811944790914,
  1979.770545006472,
  1944.8428445072448,
  1807.9694742881136,
  1724.8757340323443,
  1798.6948545788846,
  1814.9831598025937,
  1995.9364841552344,
  1944.078766836179,
  1828.8926546074292,
  1833.089840845753,
  1776.979907458187,
  1804.2616695112486,
  1805.3313949894373,
  1860.1813068416047,
  1818.3877119829308,
  1794.539625671828,
  1788.4182866616045,
  1663.844367412088,
  1530.0386174317211,
  1454.6867601728409,
  1205.5952855404787,
  1214.8662649132034,
  1230.3643353556051];

//Cambia el valor mostrado en el dropdown 'gráfica'
$(document).ready(function(){
  $('#graficas_drop a').click(function(){
    $('#selectedGrafica').text($(this).text());
    graficaData = $(this).data();
    });
});

//Cambia el valor mostrado en el dropdown 'criptomoneda'
$(document).ready(function(){
  $('#cripto_drop a').click(function(){
    $('#selectedCripto').text($(this).text());
    criptoValue = $(this).data();
    });
});

//---------------------------------------------
//Esta función cambia los valores del gráfico
function addData(datos) {
  var data1=[];var data2 = [];
  for (var k=0;k<120;k++){
    data1[k]=datos[k];
    data2[k]= NaN;
  }
  for (var m=120;m<240;m++){
    data1[m]=NaN;
    data2[m]= datos[m];
  }
  myChart.data.datasets[0].data = data1;
  myChart.data.datasets[1].data = data2;
  myChart.update();
}
//---------------------------------------------
//Esta función se encarga de predecir los valores correspondientes a los siguientes 120 días, teniendo en cuenta los 120 días anteriores
function predict(datos){
  let sts = statistics(datos);
  for (var k = 120; k < 240; k++) {
    if(datos[k-2]>datos[k-1]){
      datos[k]= datos[k-1] -(datos[k-1]-sts[0])*0.03+((Math.random())*100-50);
    }else{
      datos[k]= datos[k-1]+(sts[1]-datos[k-1])*0.03+((Math.random())*100-50);
    }
  } 
 return datos;
};
//---------------------------------------------
//Función estadística auxiliar que devuelve el v. minimo, máximo y el promedio
function statistics(data){
  let max = -1; let min = Number.MAX_VALUE; let total = 0;
  for (var i = 0; i < data.length; i++) {
    if (data[i]>max) {max = data[i]};
    if (data[i]<min) {min = data[i]};
    total += data[i];
 }
 const ret=[min,max,total/data.length]
 return ret
}
//---------------------------------------------
//Esta función toma los datos y calcula cuanto tiempo le llevará recuperar su inversión
function calcular_meses(datos,tarjeta_consumo,costokwh,tarjeta_hasheo, tarjeta_costo, cmoneda){  
  var cdiario = tarjeta_consumo*costokwh*24;//costo diario de la electricidad
  var d = 0; var datavg = 0;var ganancia = -tarjeta_costo;
  if (cmoneda =='bitcoin'){
      q=tarjeta_hasheo/240963855400;
  }else{
      q=tarjeta_hasheo/67476.3833;
  }
  
  for(var k=120;k<240;k++){
    datavg = datavg + datos[k];
  }
  datavg = datavg/120;
  do{
    d++;
    if (d<120){
      ganancia = ganancia +((q*datos[d+120])-cdiario);
    }else{
      ganancia = ganancia +(q*datavg-cdiario);
    }
  }while(ganancia<0 && d < 3600);
  if (d<3600){
    return (d/30).toFixed(2)+' meses';
  }else{
    return 'No rentable'
  }
}
//---------------------------------------------
//La siguiente función se activa en cuanto se apriete 'Simular'
$(document).ready(function (){
  $('#simular').click(function(){
   
    var graficaNombre = $('#selectedGrafica').text();   
    var cantidad = parseInt($('#grafica_cantidad').val());
    var precio = graficaData.precio * cantidad;
    var consumo = graficaData.consumo * cantidad;
    var hasheo = graficaData.frecuenciadehasheo * cantidad;
    var costokwh = parseFloat($('#costoKW').val()).toFixed(4);
    var costeenergetico = consumo * costokwh;
    var valuecripto = (criptoValue.value).toString();

    if(valuecripto == 'bitcoin'){
      datex=datosx;
    }else{
      datex = datos;
    }
    data = predict(datex);
    addData(data);    
    $('#consumo_res').text(costeenergetico.toFixed(4)+' USD/H');    
    $('#hasheo_res').text(hasheo+' MH/s');
    $('#precio_res').text(precio+' $');
    $('#watt_res').text((consumo*1000).toFixed(1)+' W');
    $('#res_meses').text(calcular_meses(data,consumo, parseFloat(costokwh),hasheo, precio,valuecripto));
  });
});

    
